<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>The Crucible Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #0b0f14; color: #e6f0ff; }
    .panel { background: #0f1720; padding: 12px; border-radius: 8px; margin-bottom: 12px; }
    #terminal { background: #000; color: #0f0; padding: 12px; height: 160px; overflow:auto; font-family: monospace; }
    button { padding: 8px 12px; margin-right:8px; }
  </style>
</head>
<body>
  <h1>The Crucible â€” Dashboard</h1>

  <div class="panel">
    <h2>Entropic Fuel</h2>
    <div>Fuel Level: <span id="fuel-level">--</span>%</div>
    <div>Status: <span id="fuel-status">--</span></div>
    <button id="recycle-btn">Recycle Shadow (API)</button>
  </div>

  <div class="panel">
    <h2>Target Resonance (HUD)</h2>
    <div>Current Resonance: <span id="resonance-value">--</span> Hz</div>
    <div>Lock Status: <span id="resonance-status">--</span></div>
  </div>

  <div class="panel">
    <h2>Chimera Syntax Console</h2>
    <input id="chimera-input" placeholder="Type command, e.g. UNLEASH_PROTOCOL_ZERO or RECYCLE_SHADOW" style="width: 70%" />
    <button id="chimera-send">Send</button>
    <div id="terminal"></div>
  </div>

  <script>
    async function refreshFuel() {
      try {
        const res = await fetch('/api/fuel');
        if (!res.ok) throw new Error('Fuel fetch failed');
        const data = await res.json();
        document.getElementById('fuel-level').textContent = data.fuel_level.toFixed ? data.fuel_level.toFixed(2) : data.fuel_level;
        document.getElementById('fuel-status').textContent = data.status;
      } catch (err) {
        console.error(err);
      }
    }

    async function refreshResonance() {
      try {
        const res = await fetch('/api/resonance');
        if (!res.ok) throw new Error('Resonance fetch failed');
        const data = await res.json();
        document.getElementById('resonance-value').textContent = data.current_resonance;
        document.getElementById('resonance-status').textContent = data.status;
      } catch (err) {
        console.error(err);
      }
    }

    async function sendRecycle() {
      try {
        const res = await fetch('/api/recycle', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ error_data: 'Manual_UI_Shadow_Event' })
        });
        const data = await res.json();
        appendTerminal("RECYCLE: " + JSON.stringify(data));
        await refreshFuel();
      } catch (err) {
        console.error(err);
      }
    }

    async function sendChimera(command) {
      try {
        const res = await fetch('/api/chimera', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ command })
        });
        const data = await res.json();
        appendTerminal("CHIMERA -> " + JSON.stringify(data));
        // Fuel might change if chimera invoked recycle
        await refreshFuel();
      } catch (err) {
        console.error(err);
      }
    }

    function appendTerminal(msg) {
      const t = document.getElementById('terminal');
      const now = new Date().toISOString();
      t.innerText = `[${now}] ${msg}\n` + t.innerText;
    }

    document.getElementById('recycle-btn').addEventListener('click', sendRecycle);
    document.getElementById('chimera-send').addEventListener('click', () => {
      const cmd = document.getElementById('chimera-input').value || '';
      sendChimera(cmd);
    });

    // Initial load
    refreshFuel();
    refreshResonance();

    // 1) Frequency tuner updates every minute: poll every 60s
    setInterval(refreshResonance, 60 * 1000);
    // Also poll fuel periodically (every 30s)
    setInterval(refreshFuel, 30 * 1000);
  </script>
</body>
</html>
